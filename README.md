# Bilibili Gender

## Description

为评论区添加性别图标。
性别开盒，免家访。

## 功能特性

### 核心功能
- **自动识别性别**: 自动从B站用户信息中提取性别数据
- **动态监听**: 实时监听评论区变化，自动为新加载的评论添加性别符号
- **视觉标识**: 使用不同颜色区分性别（男性蓝色，女性粉色）
- **性能优化**: 采用防抖机制和定期清理策略，降低资源占用

### 实现原理

#### 1. Shadow DOM 操作
脚本通过访问B站组件的Shadow DOM来获取用户信息：
- 定位评论容器: `#commentapp > bili-comments`
- 获取评论列表: `bili-comment-thread-renderer`
- 提取用户信息: `bili-comment-user-info`

#### 2. 数据提取流程
```
评论元素 → Shadow DOM → 用户信息组件 → 性别数据 (sex字段)
```

#### 3. 性能优化机制
- **防抖函数**: 300ms延迟处理，避免频繁触发
- **去重机制**: 使用Set记录已处理评论ID (rpid)
- **定期清理**: 每分钟清理过期的已处理记录，保留最近500条
- **资源释放**: 页面卸载时自动清理监听器和定时器

#### 4. 错误处理
- 最大重试次数限制 (20次)
- 递增延迟重试策略 (500ms-1000ms)
- 完善的异常捕获和日志记录

## 使用方法

### 安装
1. 安装Tampermonkey浏览器扩展
2. 点击脚本安装链接或复制脚本内容
3. 在Tampermonkey中创建新脚本并粘贴
4. 保存脚本

### 使用说明
- 访问B站视频页面 (https://www.bilibili.com/video/*)
- 脚本自动运行，在评论区用户名旁显示性别符号
- 滚动加载新评论时，自动为新评论添加性别符号

### 视觉效果
- 男性: 蓝色圆形背景 (#00AEEC)，显示 ♂ 符号
- 女性: 粉色圆形背景 (#ff6699)，显示 ♀ 符号
- 图标旋转45度，尺寸14x14像素

## 技术架构

### 主要组件

#### 全局变量
```javascript
processedComments  // 已处理评论ID集合
observer          // MutationObserver实例
cleanupTimer      // 清理定时器
retryCount        // 重试计数器
MAX_RETRIES       // 最大重试次数 (20)
```

#### 核心函数

**injectStyle(shadowRoot)**
- 功能: 向Shadow DOM注入CSS样式
- 参数: shadowRoot - 目标Shadow DOM根节点
- 特点: 防止重复注入，使用唯一ID标识

**debounce(func, delay)**
- 功能: 防抖函数，优化性能
- 参数: func - 要执行的函数，delay - 延迟时间(ms)
- 作用: 避免频繁触发导致的性能问题

**processComment(comment)**
- 功能: 处理单个评论，添加性别符号
- 参数: comment - 评论DOM元素
- 返回: boolean - 是否成功处理
- 流程: 提取rpid → 获取用户信息 → 检查性别 → 创建元素 → 添加到DOM

**addGenderSymbols()**
- 功能: 批量处理所有评论
- 特点: 包含重试机制，处理评论区未加载的情况

**setupObserver()**
- 功能: 设置MutationObserver监听器
- 监听: childList变化，检测新评论
- 优化: 只在检测到新评论时触发处理

**cleanup()**
- 功能: 清理所有资源
- 时机: 页面卸载或手动调用
- 清理: 监听器、定时器、已处理记录

**init()**
- 功能: 初始化脚本
- 执行顺序: 处理现有评论 → 设置监听器 → 启动清理定时器 → 绑定卸载事件

### 执行流程

```
页面加载 → init() → addGenderSymbols() → setupObserver()
                      ↓                    ↓
               处理现有评论            监听DOM变化
                      ↓                    ↓
               MutationObserver触发 → addGenderSymbols()
                      ↓
               处理新评论
```

## 注意事项

### 兼容性
- 仅支持B站视频页面
- 需要浏览器支持Shadow DOM
- 依赖B站现有DOM结构，页面更新可能影响功能

### 性能考虑
- 已处理评论超过1000条时自动清理
- 防抖延迟300ms，平衡响应速度和性能
- 使用Set进行快速去重查询

### 隐私说明
- 脚本仅读取公开的用户性别信息
- 不收集、存储或上传任何用户数据
- 所有处理均在本地完成

### 潜在问题
1. **B站页面更新**: DOM结构变化可能导致脚本失效
2. **网络延迟**: 用户信息加载慢时可能无法识别
3. **性别未设置**: 未设置性别的用户不会显示符号
4. **二级评论**: 当前仅支持一级评论

## Release Log

**v0.4.0** (2025-12-26)
- 修复重试计数器共享问题，提高重试机制可靠性
- 解决竞态条件风险，使用async/await确保顺序执行
- 缩小MutationObserver监听范围，优化性能
- 优化清理逻辑，保留最近100条记录避免重复处理
- 完善错误信息，添加详细上下文便于调试
- 添加性别判断日志，便于问题排查
- 优化样式注入检查，验证样式内容正确性
- 使用命名空间避免样式冲突
- 添加data-script属性标识，避免与其他脚本冲突
- 提取工具函数，提高代码复用性
- 分离定期清理函数，改善代码结构
- 添加详细的JSDoc注释，提高代码可读性
- 代码结构模块化，便于维护和扩展

**v0.3.1**
- 优化内存管理，添加定期清理机制
- 改进错误处理和重试逻辑
- 添加资源释放功能

**v0.2**
- 使用CSS样式重构性别图标
- 添加Shadow DOM支持

**v0.1**
- 评论区一级评论添加性别字符

## 开发说明

### 调试
脚本会在控制台输出以下日志：
- `[BiliBili Gender] 脚本已启动`
- `[BiliBili Gender] 初始化`
- `[BiliBili Gender] 处理了 X 条新评论`
- `[BiliBili Gender] 监听器已启动`
- `[BiliBili Gender] 已清理过多的已处理记录`
- `[BiliBili Gender] 资源已清理`

### 扩展建议
1. 支持二级评论性别显示
2. 添加自定义颜色配置
3. 支持其他B站页面（动态、专栏等）
4. 添加开关控制功能

### 维护要点
- 关注B站DOM结构变化
- 监控性能指标
- 定期检查兼容性
- 优化错误处理逻辑
